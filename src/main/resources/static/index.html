<html>
<head>
    <meta charset="utf-8"/>
    <title>A Leaflet map!</title>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <link href="the-datepicker.css" rel="stylesheet"/>
    <!--script type="text/javascript" src="js/leaflet.js"></script-->
    <script type="text/javascript" src="https://unpkg.com/leaflet@1.1.0/dist/leaflet-src.js"></script>
    <!--link rel="stylesheet" type="text/css" href="css/leaflet.css"-->
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css">

    <script type="text/javascript" src="the-datepicker.js"></script>

    <style>
        #map {
            margin-top: 20px;
            margin-bottom: 20px;
            width: 50%;
            height: 50%;
            align-self: center;
        }

        .center {
            margin: auto;
            width: 50%;
            padding: 10px;
        }

        .body {
            margin: auto;
            width: 98%;
            height: 95%;
            padding: 0px;
        }
    </style>
</head>
<body>
<div class="body">
    <div class="center">
        <p>Benutzung:
            Auf Karte klicken, um neuen Punkt auszuwählen.
            Anschließend c drücken, um obere linke Ecke des Rechtecks für Suche zu definieren.
            Danach nochmal klicken, neuen Punkt aussuchen.
            Anschließend v drücken, um untere rechte Ecke des Rechtecks für Suche zu definieren.
            Optional:
            d drücken, um das Rechteck zu zeichnen (Visuell auf Karte anzuzeigen)</p>
        <p>
            Zuletzt die anderen Felder manuell wie gewünscht ausfüllen. Das Datum (2x) wird durch interaktive Auswahl
            per JS ausgewählt. Dann gibt man noch den gewünschten OHDM Subklassennamen ein (Siehe Map Features von OSM)
            und
            drückt auf "Submit for query". Nun sollte man eine generierte GEOSparql-Anfrage erhalten.
        </p>
        <button onclick="deletePointsFromMap()">Delete Polygon</button>
    </div>
    <div id="map" class="center"></div>
    <div class="center">
        <table>
            <tr>
                <td rowspan="12">
                    <p>Valid-From: <input type="text" id="validfrom" name="valid from" value="" required></p>
                    <p>Valid-Until: <input type="text" id="validuntil" name="valid until" value="" required></p>
                    <select id="classid" required>
                        <option value="1">Aerialway</option>
                        <option value="2">Aeroway</option>
                        <option value="3">Amenity</option>
                        <option value="4">Barrier</option>
                        <option value="5">Boundary</option>
                        <option value="6">Building</option>
                        <option value="7">Craft</option>
                        <option value="8">Emergency</option>
                    </select>
                    <p>QUERY:

                    <div class="center">
                        <button type="button" id="submitbtn" onclick="parseQuery()">Submit for query</button>
                    </div>
                    </p>
                </td>
                <td>
                    <p><b>URI ENCODED QUERY</b></p>
                    <div id="query"></div>
                </td>
                <td>
                    <p><b>URI DECODED QUERY</b></p>
                    <div id="queryDecoded"></div>
                </td>
                <td>
                    <p><b>Default Query for visualizing some data:</b></p>
                    <div id="defaultQuery">
                    </div>
                    <button onclick="iteratePointsFromQuery()">Submit query and visualize Data</button>
                </td>
            </tr>
        </table>

    </div>
</div>


<script>
    var lat = 47.03; // default value
    var long = 10.2; // default value
    var listOfCords = [];
    var polygonOnMap;
    var osmFeatureClasses = {};
    const UNDEFINED = "undefined";
    var subClasses = [];
    const examplequery = "PREFIX gn: <http://www.geonames.org/ontology#>\n" +
        "PREFIX xsd: <http://www.w3.org/2001/XMLSchema#> \n" +
        "PREFIX spatial: <http://jena.apache.org/spatial#> \n" +
        "PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>\n" +
        " \n" +
        "\n" +
        "SELECT ?link ?name ?lat ?lon\n" +
        "WHERE  {  \n" +
        "   ?link spatial:nearby(51.139725 -0.895386 50 'km') .  \n" +
        "   ?link gn:name ?name .  \n" +
        "   ?link gn:featureCode gn:S.AIRP .\n" +
        "   ?link geo:lat ?lat .\n" +
        "   ?link geo:long ?lon\n" +
        "}";
    const queryURL = "http://www.lotico.com:3030/lotico/sparql?query=PREFIX+gn%3A+%3Chttp%3A%2F%2Fwww.geonames.org%2Fontology%23%3E%0D%0APREFIX+xsd%3A+%3Chttp%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema%23%3E+%0D%0APREFIX+spatial%3A+%3Chttp%3A%2F%2Fjena.apache.org%2Fspatial%23%3E+%0D%0APREFIX+geo%3A+%3Chttp%3A%2F%2Fwww.w3.org%2F2003%2F01%2Fgeo%2Fwgs84_pos%23%3E%0D%0A+%0D%0A%0D%0ASELECT+%3Flink+%3Fname+%3Flat+%3Flon%0D%0AWHERE++%7B++%0D%0A+++%3Flink+spatial%3Anearby%2851.139725+-0.895386+50+%27km%27%29+.++%0D%0A+++%3Flink+gn%3Aname+%3Fname+.++%0D%0A+++%3Flink+gn%3AfeatureCode+gn%3AS.AIRP+.%0D%0A+++%3Flink+geo%3Alat+%3Flat+.%0D%0A+++%3Flink+geo%3Along+%3Flon%0D%0A%7D&output=json";
    document.getElementById("defaultQuery").innerText = "\n" + queryURL + "\n\n This query should find nearby airpots of London. Example query from www.geosparql.org";
    var queryResult;
    //get result from query
    const Http = new XMLHttpRequest();
    Http.open("GET", queryURL);
    Http.send();

    Http.onreadystatechange = function () {
        if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
            queryResult = JSON.parse(Http.responseText);
        }
    };
    // Aerialway
    // fill with all known subclasses
    subClasses.push(UNDEFINED);
    subClasses.push("cable_car");// lines
    subClasses.push("gondola");// lines
    subClasses.push("chair_lift");// lines
    subClasses.push("mixed_lift");// lines
    subClasses.push("drag_lift");// lines
    subClasses.push("t-bar");// lines
    subClasses.push("j-bar");// lines
    subClasses.push("platter");// lines
    subClasses.push("rope_tow");// lines
    subClasses.push("magic_carpet"); // lines
    subClasses.push("zip_line");

    subClasses.push("pylon"); // point
    subClasses.push("station"); // point and polygone

    subClasses.push("canopy"); // lines
    subClasses.push("goods"); // lines

    osmFeatureClasses['aerialway'] = {subClasses};
    // Aeroway
    subClasses = [];

    // fill with all known subclasses
    subClasses.push(UNDEFINED);
    subClasses.push("apron");
    subClasses.push("gate");
    subClasses.push("hangar");
    subClasses.push("helipad");
    subClasses.push("navigationaid");
    subClasses.push("runway");
    subClasses.push("taxilane");
    subClasses.push("taxiway");
    subClasses.push("apron");
    subClasses.push("terminal");
    subClasses.push("windsock");

    osmFeatureClasses['aeroway'] = {subClasses};

    // initialize the map
    var map = L.map('map').setView([0, 0], 3);


    // load a tile layer
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        noWrap: true
    }).addTo(map);

    map.on('click', function (e) {

        lat = e.latlng.lat;
        long = e.latlng.lng;

        const tupleOfCords = [lat, long];
        listOfCords.push(tupleOfCords);

        if (listOfCords.length >= 3) {
            var polygon = L.polygon(listOfCords, {color: 'red'});
            if (polygonOnMap)
                window.map.removeLayer(window.polygonOnMap);
            polygonOnMap = polygon.addTo(map);
        }
    });

    function parseQuery() {
        if (listOfCords.length < 3) {
            alert("Polygon must have at least 3 points!");
            return;
        }
        const validfrom = document.getElementById('validfrom').value;
        const validuntil = document.getElementById('validuntil').value;
        if(!validfrom || !validuntil){
            alert("Please enter the validfrom and validuntil dates!");
            return;
        }
        const classid = document.getElementById('classid').value;
        var stringOfCords = "";
        for (i = 0; i < listOfCords.length; i++) {
            const element = listOfCords[i];
            stringOfCords += element[0] + " " + element[1] + ", ";
        }
        stringOfCords += listOfCords[0][0] + " " + listOfCords[0][1];

        var query = "PREFIX ohdm: <http://www.ohdm.net/ohdm/schema/1.0>\n" +
            "PREFIX strdf: <http://strdf.di.uoa.gr/ontology#>\n" +
            "PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\n" +
            "select ?o ?geom ?c ?since ?until\n" +
            "where \n" +
            "{\n" +
            "?s ohdm:name ?o ;\n" +
            "strdf:hasGeometry ?geom ;\n" +
            "ohdm:validsince ?since ;\n" +
            "ohdm:validuntil ?until ;\n" +
            "ohdm:classid ?c ;\n" +
            "filter(?c = \"" + classid + "\"^^xsd:string)\n" +
            "filter(strdf:within(?geom,\n" +
            "\"POLYGON((" + stringOfCords + "));http://www.opengis.net/def/crs/EPSG/0/3857\"^^strdf:WKT)\n"
            + ")\n"
            + "filter(?since > \"" + validfrom + "\"^^xsd:date)\n"
            + "filter(?until < \"" + validuntil + "\"^^xsd:date)\n"
            + "}\n";

        document.getElementById("queryDecoded").innerText = query;
        query = encodeURIComponent(query);
        document.getElementById("query").innerText = query;
    }

    function iteratePointsFromQuery() {
        for (i = 0; i < queryResult.results.bindings.length; i++) {
            var obj = queryResult.results.bindings[i];
            var lat = obj.lat.value;
            var lon = obj.lon.value;
            drawPointsFromQuery([lat, lon])
        }
    }

    function drawPointsFromQuery(tupleOfPoint) {
        L.marker(tupleOfPoint).addTo(map);
    }

    function deletePointsFromMap() {
        listOfCords = [];
        if (polygonOnMap)
            window.map.removeLayer(window.polygonOnMap);
    }

    document.addEventListener('keydown', (event) => {
        const keyName = event.key;

        if (keyName === 'c') {
            iteratePointsFromQuery();
        }
    }, false);

    callBound1 = function () {
        document.getElementById("bound1.lat").value = lat;
        document.getElementById("bound1.long").value = long;
    };


    callBound2 = function () {
        document.getElementById("bound2.lat").value = lat;
        document.getElementById("bound2.long").value = long;
    };
</script>

<script>
    const input = document.getElementById('validfrom');
    const datepicker = new TheDatepicker.Datepicker(input);
    datepicker.render();
    const input2 = document.getElementById('validuntil');
    const datepicker2 = new TheDatepicker.Datepicker(input2);
    datepicker2.render();
    datepicker.options.setInputFormat("Y-m-d");
    datepicker2.options.setInputFormat("Y-m-d");

    var select = document.getElementById("select");

    var mapFeatures = ["motorway", "trunk", "primary", "secondary", "tertiary", "unclassified", "residential",
        "motorway_link", "trunk_link", "primary_link", "secondary_link", "tertiary_link"
    ]

    for (var i = 0; i < mapFeatures.length; i++) {
        var option = document.createElement("OPTION");
        txt = document.createTextNode(mapFeatures[i]);
        option.appendChild(txt);
        option.setAttribute("value", mapFeatures[i]);
        select.insertBefore(option, select.lastChild);
    }

    function getSelectedCountry() {
        var selectedCountry = document.getElementById("select");
    }

    getSelectedCountry();
</script>


</body>
</html>