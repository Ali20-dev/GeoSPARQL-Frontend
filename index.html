<html>
<head>
    <meta charset="utf-8"/>
    <title>A Leaflet map!</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="proj4.js"></script>
    <script src="proj4leaflet.js"></script>
    <link href="the-datepicker.css" rel="stylesheet"/>
    <script src="the-datepicker.js"></script>

    <style>
        #map {
            margin-top: 20px;
            margin-bottom: 20px;
            width: 50%;
            height: 50%;
            align-self: center;
        }

        .center {
            margin: auto;
            width: 50%;
            padding: 10px;
        }

        .body {
            margin: auto;
            width: 98%;
            height: 95%;
            padding: 0px;
        }
    </style>
</head>
<body>
<div class="body">
    <div class="center">
        <p>Benutzung:
            Auf Karte klicken, um neuen Punkt auszuwählen.
            Anschließend c drücken, um obere linke Ecke des Rechtecks für Suche zu definieren.
            Danach nochmal klicken, neuen Punkt aussuchen.
            Anschließend v drücken, um untere rechte Ecke des Rechtecks für Suche zu definieren.
            Optional:
            d drücken, um das Rechteck zu zeichnen (Visuell auf Karte anzuzeigen)</p>
        <p>
            Zuletzt die anderen Felder manuell wie gewünscht ausfüllen. Das Datum (2x) wird durch interaktive Auswahl
            per JS ausgewählt. Dann gibt man noch den gewünschten OHDM Subklassennamen ein (Siehe Map Features von OSM)
            und
            drückt auf "Submit for query". Nun sollte man eine generierte GEOSparql-Anfrage erhalten.
        </p>
    </div>
    <div id="map" class="center"></div>
    <div class="center">
        <table>
            <tr>
                <td rowspan="12">
                    <p>Valid-From: <input type="text" id="validfrom" name="valid from" value="" required></p>
                    <p>Valid-Until: <input type="text" id="validuntil" name="valid until" value="" required></p>
                    <p>PolyBound1.lat: <input type="text" name="bound1" id="bound1.lat" value="" required></p>
                    <p>PolyBound1.long: <input type="text" name="bound1" id="bound1.long" value="" required></p>
                    <p>PolyBound2.lat: <input type="text" name="bound2" id="bound2.lat" value="" required></p>
                    <p>PolyBound2.long: <input type="text" name="bound2" id="bound2.long" value="" required></p>
                    <p>Subclassname: <input type="text" name="subclassname" id="subclassname" value="" required></p>
                    <p>QUERY:

                    <div class="center">
                        <button type="button" id="submitbtn" onclick="parseQuery()">Submit for query</button>
                    </div></p>
                </td>
                <td>
                    <div id="query"></div>
                </td>
            </tr>
        </table>

    </div>
</div>


<script>
    var lat = 47.03; // default value
    var long = 10.2; // default value

    // initialize the map
    var map = L.map('map').setView([0, 0], 3);


    // load a tile layer
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        noWrap: true
    }).addTo(map);

    map.on('click', function (e) {

        lat = e.latlng.lat;
        long = e.latlng.lng;
        alert("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng)


    });

    let inputs = document.querySelectorAll('[type="text"]'),
        button = document.querySelector('#submitbtn');
    button.disabled = true;

    for (i = 0; i < inputs.length; i++) {
        inputs[i].addEventListener('input', () => {
            let values = []
            inputs.forEach(v => values.push(v.value))
            button.disabled = values.includes('')
        })
    }

    var rectangle;

    function parseQuery() {
        const lat1 = document.getElementById("bound1.lat").value;
        const long1 = document.getElementById("bound1.long").value;
        const lat2 = document.getElementById("bound2.lat").value;
        const long2 = document.getElementById("bound2.long").value;
        const validfrom = document.getElementById('validfrom').value;
        const validuntil = document.getElementById('validuntil').value;
        const subclassname = document.getElementById('subclassname').value;
        var query = "PREFIX ohdm: http://www.ohdm.net/ohdm/schema/1.0\n" +
            "PREFIX strdf: http://strdf.di.uoa.gr/ontology#\n" +
            "PREFIX xsd: http://www.w3.org/2001/XMLSchema#\n" +
            "select ?o ?geom ?c ?since ?until\n" +
            "where \n" +
            "{\n" +
            "?s ohdm:name ?o ;\n" +
            "strdf:hasGeometry ?geom ;\n" +
            "ohdm:validsince ?since ;\n" +
            "ohdm:validuntil ?until ;\n" +
            "ohdm:classid ?c ;\n" +
            "ohdm:subclassname ?subclassname .\n" +
            "filter(?subclassname = \"" + subclassname + "\"^^xsd:string)\n" +
            "filter(strdf:within(?geom,\n" +
            "\"POLYGON((" + long1 + " " + lat1 + ", "
            + long1 + " " + lat2 + ", "
            + long2 + " " + lat2 + ", "
            + long2 + " " + lat1 + ", "
            + long1 + " " + lat1 + "));http://www.opengis.net/def/crs/EPSG/0/3857\"^^strdf:WKT)\n"
            + ")\n"
            + "filter(?since > \"" + validfrom + "\"^^xsd:date)\n"
            + "filter(?until < \"" + validuntil + "\"^^xsd:date)\n"
            + "}\n"

        document.getElementById("query").innerText = query;
    }

    function transformLatAndLong() {
        var lat1 = document.getElementById("bound1.lat").value;
        var long1 = document.getElementById("bound1.long").value;
        var lat2 = document.getElementById("bound2.lat").value;
        var long2 = document.getElementById("bound2.long").value;
        var bngcoords = proj4l(bngprojection, [lat1, long1]);
        var bngcoords2 = proj4(bngprojection, [lat2, long2]);
        console.log(bngcoords);
        console.log(bngcoords2);
    }

    function drawRectangle() {
        var lat1 = document.getElementById("bound1.lat").value;
        var long1 = document.getElementById("bound1.long").value;
        var lat2 = document.getElementById("bound2.lat").value;
        var long2 = document.getElementById("bound2.long").value;
        console.log(lat1 + " " + long1 + " ");
        //L.rect(lat1, long1, lat2, long2).addTo;
        var bounds = [[lat1, long1], [lat2, long2]];
        if (rectangle)
            window.map.removeLayer(window.rectangle);
        rectangle = L.rectangle(bounds).addTo(map);
        transformLatAndLong();
    }

    document.addEventListener('keydown', (event) => {
        const keyName = event.key;

        if (keyName === 'c') {
            callBound1();
        } else if (keyName === 'v') {
            callBound2();
        } else if (keyName === "d") {
            drawRectangle();
        }
    }, false);

    callBound1 = function () {
        document.getElementById("bound1.lat").value = lat;
        document.getElementById("bound1.long").value = long;
    };


    callBound2 = function () {
        document.getElementById("bound2.lat").value = lat;
        document.getElementById("bound2.long").value = long;
    };
</script>

<script>
    const input = document.getElementById('validfrom');
    const datepicker = new TheDatepicker.Datepicker(input);
    datepicker.render();
    const input2 = document.getElementById('validuntil');
    const datepicker2 = new TheDatepicker.Datepicker(input2);
    datepicker2.render();
    datepicker.options.setInputFormat("Y-m-d");
    datepicker2.options.setInputFormat("Y-m-d");

    var select = document.getElementById("select");

    var mapFeatures = ["motorway", "trunk", "primary", "secondary", "tertiary", "unclassified", "residential",
        "motorway_link", "trunk_link", "primary_link", "secondary_link", "tertiary_link"
    ]

    for (var i = 0; i < mapFeatures.length; i++) {
        var option = document.createElement("OPTION");
        txt = document.createTextNode(mapFeatures[i]);
        option.appendChild(txt);
        option.setAttribute("value", mapFeatures[i]);
        select.insertBefore(option, select.lastChild);
    }

    function getSelectedCountry() {
        var selectedCountry = document.getElementById("select");
    }

    getSelectedCountry();
</script>


</body>
</html>