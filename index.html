<html>
<head>
    <title>A Leaflet map!</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="proj4.js"></script>
    <script src="proj4leaflet.js"></script>
    <link href="the-datepicker.css" rel="stylesheet" />
    <script src="the-datepicker.js"></script>

    <style>
        #map {
            margin-top: 170px;
            width: 1170px;
            height: 500px;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div>
    Valid-From: <input type="text" id="validfrom" name="valid from" value="" required>
    Valid-Until: <input type="text" id="validuntil" name="valid until" value=""required>
    PolyBound1.lat: <input type="text" name="bound1" id="bound1.lat" value="" required>
    PolyBound1.long: <input type="text" name="bound1" id="bound1.long" value="" required>
    PolyBound2.lat: <input type="text" name="bound2" id="bound2.lat" value="" required>
    PolyBound2.long: <input type="text" name="bound2" id="bound2.long" value="" required>

    QUERY: <div id="query"></div>

    <button type="button" id="submitbtn" onclick="parseQuery()">SUBMIT for query</button>
</div>

<script>
    var lat = 47.03; // default value
    var long = 10.2; // default value

    // initialize the map
    var map = L.map('map').setView([0, 0], 3);


    // load a tile layer
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        noWrap: true
    }).addTo(map);

    map.on('click', function (e) {

        lat = e.latlng.lat;
        long = e.latlng.lng;
        alert("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng)


    });

    var rectangle;

    function parseQuery() {
        const lat1 = document.getElementById("bound1.lat").value;
        const long1 = document.getElementById("bound1.long").value;
        const lat2 = document.getElementById("bound2.lat").value;
        const long2 = document.getElementById("bound2.long").value;
        const validfrom = document.getElementById('validfrom').value;
        const validuntil = document.getElementById('validuntil').value;
        var query = "PREFIX ohdm: http://www.ohdm.net/ohdm/schema/1.0\n" +
            "PREFIX strdf: http://strdf.di.uoa.gr/ontology#\n" +
            "PREFIX xsd: http://www.w3.org/2001/XMLSchema#\n" +
            "select ?o ?geom ?c ?since ?until\n" +
            "where \n" +
            "{\n" +
            "?s ohdm:name ?o ;\n" +
            "strdf:hasGeometry ?geom ;\n" +
            "ohdm:validsince ?since ;\n" +
            "ohdm:validuntil ?until ;\n" +
            "ohdm:classid ?c .\n" +
            "filter(?c = \"42\"^^xsd:integer)\n" +
            "filter(strdf:within(?geom,\n" +
            "\"POLYGON((" + long1 + " " + lat1 + ", "
                          + long1 + " " + lat2 + ", "
                          + long2 + " " + lat2 + ", "
                          + long2 + " " + lat1 + ", "
                          + long1 + " " + lat1 + "));http://www.opengis.net/def/crs/EPSG/0/3857\"^^strdf:WKT)\n"
            + ")\n"
            + "filter(?since > \"" + validfrom + "\"^^xsd:date)\n"
            + "filter(?until < \"" + validuntil + "\"^^xsd:date)\n"
            + "}\n"

        document.getElementById("query").innerText = query;
    }

    function transformLatAndLong() {
        var lat1 = document.getElementById("bound1.lat").value;
        var long1 = document.getElementById("bound1.long").value;
        var lat2 = document.getElementById("bound2.lat").value;
        var long2 = document.getElementById("bound2.long").value;
        var bngcoords = proj4l(bngprojection, [lat1, long1]);
        var bngcoords2 = proj4(bngprojection, [lat2, long2]);
        console.log(bngcoords);
        console.log(bngcoords2);
    }

    function drawRectangle() {
        var lat1 = document.getElementById("bound1.lat").value;
        var long1 = document.getElementById("bound1.long").value;
        var lat2 = document.getElementById("bound2.lat").value;
        var long2 = document.getElementById("bound2.long").value;
        console.log(lat1 + " " + long1 + " " );
        //L.rect(lat1, long1, lat2, long2).addTo;
        var bounds = [[lat1, long1], [lat2, long2]];
        if(rectangle)
            window.map.removeLayer(window.rectangle);
        rectangle = L.rectangle(bounds).addTo(map);
        transformLatAndLong();
    }

    document.addEventListener('keydown', (event) => {
        const keyName = event.key;

        if (keyName === 'c') {
            callBound1();
        } else if (keyName === 'v') {
            callBound2();
        } else if (keyName === "d") {
            drawRectangle();
        }
    }, false);

    callBound1 = function () {
        document.getElementById("bound1.lat").value = lat;
        document.getElementById("bound1.long").value = long;
    };


    callBound2 = function () {
        document.getElementById("bound2.lat").value = lat;
        document.getElementById("bound2.long").value = long;
    };
</script>

<select id="select">
    <option value="default">Choose a map feature</option>
</select>

<script>
    const input = document.getElementById('validfrom');
    const datepicker = new TheDatepicker.Datepicker(input);
    datepicker.render();
    const input2 = document.getElementById('validuntil');
    const datepicker2 = new TheDatepicker.Datepicker(input2);
    datepicker2.render();
    datepicker.options.setInputFormat("Y-m-d");
    datepicker2.options.setInputFormat("Y-m-d");

    var select = document.getElementById("select");

    var mapFeatures = ["motorway", "trunk", "primary", "secondary", "tertiary", "unclassified", "residential",
        "motorway_link", "trunk_link", "primary_link", "secondary_link", "tertiary_link"
    ]

    for (var i = 0; i < mapFeatures.length; i++) {
        var option = document.createElement("OPTION");
        txt = document.createTextNode(mapFeatures[i]);
        option.appendChild(txt);
        option.setAttribute("value", mapFeatures[i]);
        select.insertBefore(option, select.lastChild);
    }

    function getSelectedCountry() {
        var selectedCountry = document.getElementById("select");
    }

    getSelectedCountry();
</script>


</body>
</html>